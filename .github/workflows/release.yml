name: Release → build & deploy

on:
  release:
    types: [published]              # fires only when you press “Publish release”

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-weather
  RELEASE_TAG: ${{ github.event.release.tag_name }}

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.RELEASE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
          build-args: |
            APP_VERSION=${{ env.RELEASE_TAG }}

  verify-version:
    needs: build-push
    runs-on: ubuntu-latest
    steps:
      - name: Pull & run container locally
        run: |
          docker run -d --name test -e APP_VERSION=${{ env.RELEASE_TAG }} -p 18000:8000 ${{ env.IMAGE_NAME }}:${{ env.RELEASE_TAG }}
          sleep 10
      - name: Check /api/hello version matches tag
        run: |
          ver=$(curl -s http://localhost:18000/api/hello | jq -r '.version')
          if [ "$ver" != "${{ env.RELEASE_TAG }}" ]; then
            echo "Version mismatch: $ver vs ${{ env.RELEASE_TAG }}"
            exit 1
          fi
      - run: docker rm -f test

  deploy:
    needs: verify-version
    runs-on: ubuntu-latest
    steps:
      - name: Copy docker-compose to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "docker-compose.yaml"
          target: "~/fastapi-weather/"

      - name: SSH → pull new image & reload with zero downtime
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd ~/fastapi-weather
            export APP_VERSION=${{ env.RELEASE_TAG }}
            export IMAGE_NAME=${{ env.IMAGE_NAME }}
            docker compose pull api
            # Run second instance on a spare port, wait healthy, then swap (poor-man's blue/green)
            docker compose up -d --no-deps --scale api=2 --force-recreate
            docker compose ps
            # Optional: remove old replica after confirming traffic switch
            sleep 10
            docker compose up -d --no-deps --scale api=1 --force-recreate
            docker image prune -f
